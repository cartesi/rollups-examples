# Simple Calc DApp

This example shows how to build and interact with a Cartesi Rollups Dapp called "calc" that performs a two-operand calculation for each input received as a corresponding output notice. The operands and operator inputs are sent to the application as a hexadecimal JSON string. The back-end of this DApp is written in Python. Before we can understand how to use the DApp, we must first build it properly, as shown in the Building section.

## Building the environment

To run the calc DApp example, clone the repository as follows:

```shell
$ git clone https://github.com/cartesi/rollups-examples.git
```

Then, build the back-end for the calc example:

```shell
$ cd rollups-examples/calc
$ make machine
```

## Running the environment

To start the containers in production mode, run:

```shell
$ docker-compose up --build
```

_Note:_ If you decide to use [Docker Compose V2](https://docs.docker.com/compose/cli-command/), make sure you set the [compatibility flag](https://docs.docker.com/compose/cli-command-compatibility/) when executing the command (e.g., `docker-compose --compatibility up`).

_Note:_ If running the make files or docker causes permission failed error, run as superuser.

Allow some time for the infrastructure to be ready.
How much will depend on your system, but after some time showing the error `"concurrent call in session"`, eventually the container logs will repeatedly show the following:

```shell
server_manager_1      | Received GetVersion
server_manager_1      | Received GetStatus
server_manager_1      |   default_rollups_id
server_manager_1      | Received GetSessionStatus for session default_rollups_id
server_manager_1      |   0
server_manager_1      | Received GetEpochStatus for session default_rollups_id epoch 0
```

To stop the containers, first, end the process with `Ctrl + C`.
Then, remove the containers and associated volumes by executing:

```shell
$ docker-compose down -v
```
## Understanding the application

![cartesi drawio](https://user-images.githubusercontent.com/4421825/152856411-85dfdecc-97f6-4269-b9f2-004fc3aae7bb.png)


The calc application is a simple math calculator that performs two operands' operations inside the cartesi machine. The input expected is a JSON string with the operands and the operator. For instance
```
{"op": "+", "opdf": "36", "opds": "69"}
```
Where "op" represents the operation (+-\*/), "opdf" is the first operand, and "opds" is the second operand. Note that this JSON string should necessarily be in hexadecimal. In the example above, the hexadecimal should be like below. 
```
0x7b226f70223a20222b222c20226f706466223a20223336222c20226f706473223a20223639227d
```
You can use the calc front-end in this project which does the conversion of the operations in a simple way for users. It is also a python script in the .calc/front folder.

In the next section, you can see how to interact with the DApp to send inputs and see the notices array.

## Interacting with the application

### Command-Line Input

With the infrastructure in place, go to a separate terminal window and send an input as follows:

```shell
$ docker exec calc_hardhat_1 npx hardhat --network localhost calc:addInput --input "0x7b226f70223a20222b222c20226f706466223a20223336222c20226f706473223a20223639227d"
```

When you receive a response similar to the one below, you know your input was accepted.

```shell
Added input '0x7b226f70223a20222b222c20226f706466223a20223336222c20226f706473223a20223639227d' to epoch '0' (timestamp: 1643998586, signer: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266, tx: 0x765a93faa7acc2a15cb2e577c16ffd0c7d106599c62b0b5c9be9dfc7fc9ee03f)
```
### Seeing Results, notices, and more

To verify the notices generated by your inputs, run the command:

```shell
$ curl http://localhost:4000/graphql -H 'Content-Type: application/json' -d '{ "query" : "query getNotice { GetNotice( query: { session_id: \"default_rollups_id\", epoch_index: \"0\", input_index: \"0\" } ) { session_id epoch_index input_index notice_index payload } }" }'
```

The response should be something like this:

```shell
{"data":{"GetNotice":[{"session_id":"default_rollups_id","epoch_index":"0","input_index":"0","notice_index":"0","payload":"63617274657369da"}]}}
```
You can also run those commands in the "playground graphql" host at "http://localhost:4000/graphql", it is easier to understand and manipulate the structures defined in (https://github.com/cartesi/rollups/blob/main/src/reader/src/graphql/typeDefs/typeDefs.graphql). For example, the GetNotice query can be run in the localhost, as shown below.

![image](https://user-images.githubusercontent.com/4421825/152856704-c0c33c13-f695-4d43-bec3-9b6e6cfb9d07.png)


We can see the calculation's payload result in the "payload" attribute. In this example, every input generates only one notice, so you can get the calculation result by checking the notices of an input by the index.

We can also see the full array of notices with the GetEpochStatus query with the command below.

```shell
query{ GetEpochStatus(query:{session_id: "default_rollups_id", epoch_index:"0"})
      { processed_inputs{ input_index 
      result{
        notices{
        payload} } } } }
```

The results will be displayed as shown in the image below.

![image](https://user-images.githubusercontent.com/4421825/152856017-ac301f70-0dd6-42f2-af55-1312ce17ddd8.png)


### Sending inputs with the front-end 

We can also send inputs with the simple front end inside the front folder to simplify. It's a simple script that converts the operation information into a proper input. With the infrastructure ready, run the script.

```
calculatorfront.py
```
The script should run expecting the user inputs, as shown in the following picture.

![image](https://user-images.githubusercontent.com/4421825/152860785-b0c6a3c6-dade-4ca1-ae12-54482a39c287.png)


## Advancing time

To advance time, to simulate the passing of epochs, run:

```shell
$ docker exec calc_hardhat_1 npx hardhat --network localhost util:advanceTime --seconds 864010
```

## Running the environment in host mode

When developing an application, it is often essential to quickly test and debug it. For that matter, it is possible to run the Cartesi Rollups environment in [host mode](../README.md#host-mode) so that the DApp's back-end can be executed directly on the host machine, allowing it to be debugged using standard development tools such as an IDE.

The first step is to run the environment in host mode using the following command:

```shell
docker-compose -f docker-compose-host.yml up --build
```

The next step is to run the calc server in your machine. The application is written in Python, so you need to have `python3` installed.

To start the calc server, run the following commands in a dedicated terminal:

```shell
cd calc/server/
python3 -m venv .env
. .env/bin/activate
pip install -r requirements.txt
HTTP_DISPATCHER_URL="http://127.0.0.1:5004" gunicorn --preload --workers 1 --bind 0.0.0.0:5003 calc:app
```

The calc server will run on port `5003` and send the corresponding notices to port `5004`. After it's successfully started, it should print an output like the following:

```
[2022-01-21 12:38:23,971] INFO in calc: HTTP dispatcher url is http://127.0.0.1:5004
[2022-01-21 12:38:23 -0500] [79032] [INFO] Starting gunicorn 19.9.0
[2022-01-21 12:38:23 -0500] [79032] [INFO] Listening at: http://0.0.0.0:5003 (79032)
[2022-01-21 12:38:23 -0500] [79032] [INFO] Using worker: sync
[2022-01-21 12:38:23 -0500] [79035] [INFO] Booting worker with pid: 79035
```

After that, you can interact with the application typically [as explained above](#interacting-with-the-application).

When you add an input, you should see it being processed by the calc server as follows:

```shell
[2022-01-21 15:58:39,555] INFO in calc: Received advance request body {'metadata': {'msg_sender': '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266', 'epoch_index': 0, 'input_index': 0, 'block_number': 11, 'time_stamp': 1642791522}, 'payload': '0x636172746573690d0a'}
[2022-01-21 15:58:39,556] INFO in calc: Adding notice
[2022-01-21 15:58:39,650] INFO in calc: Received notice status 201 body b'{"index":0}'
[2022-01-21 15:58:39,651] INFO in calc: Finishing
[2022-01-21 15:58:39,666] INFO in calc: Received finish status 202
```

Finally, to stop the containers, removing any associated volumes, execute:

```shell
docker-compose -f docker-compose-host.yml down -v
```
