# ETHER DApp

This DApp shows how to parse ETHER deposits sent by the ERTHER Portal, which is where all legitimate ETHER deposits come from, and how to issue vouchers so the amount deposited can be withdrawn later on.

A deposit must have a payload, whose format is defined at the [ETHER Portal contract](https://github.com/cartesi/rollups/blob/main/onchain/rollups/contracts/portals/EtherPortal.sol), which is part of the Cartesi Rollups contract.

After the deposit is parsed, the application issues a voucher to return the amount back to the depositor ("I don't want your money!"). This voucher can then be executed to withdraw the amount from the Portal and recover the assets. Note that to perform a withdrawal, we use the [withdrawEther](https://github.com/cartesi/rollups/blob/29711da9cd83bb56477ea1855286f2c722a17337/onchain/rollups/contracts/dapp/CartesiDApp.sol#L230) method of the DApp contract, differently from the erc20 example where the DApp uses the transfer method of the ERC20 token. To successfully execute this method through a voucher, the DApp needs to know its own Layer-1 address to set the destination field in the voucher.The [Dapp Address Relay](https://github.com/cartesi/rollups/blob/main/onchain/rollups/contracts/relays/DAppAddressRelay.sol) contract is the tool that the Cartesi Rollups framework has available to feed this information to the DApp in a secure way.

Malformed inputs or inputs sent by addresses other than the `DApp Address Relay` and the `Ether Portal` will be rejected.

## Interacting with the application
> [!IMPORTANT]  
> Requires the [cast](https://book.getfoundry.sh/reference/cast/cast) command from [Foundry](https://book.getfoundry.sh/getting-started/installation)!

Since this DApp uses the `withdrawEther` method of the DApp contract to perform withdraws, it has to know its own address to encode this method call in a voucher. So first, go to a separate terminal window and execute the `send_dapp_addr.sh` script. This script uses the [relayDAppAddress](https://github.com/cartesi/rollups/blob/29711da9cd83bb56477ea1855286f2c722a17337/onchain/rollups/contracts/relays/DAppAddressRelay.sol#L20) method of the DApp Address Relay Contract to inform the L2 of its L1 address:
 
```shell
./send_dapp_addr
```

Then, perform a deposit of some ETHER using the `send_eth.sh` script. This script uses the ETHER Portal to send a deposit to the DApp:

```shell
./send_eth.sh 1000
```

In order to verify the notices generated by your inputs, run the command:

```shell
yarn start notice list
```

The payload of the notice should be something like this:

```json
"Deposit received from: 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266; ETH Amount: 1000000000000000000000"
```

After the deposit, check the balance of the account used in the operation:

```shell
cast balance --rpc-url http://localhost:8545 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
```

In order to check the voucher generated for the deposit, execute the following command:

```shell
yarn start voucher list
```

After confirming the generation of the voucher, advance the time using this [command](https://github.com/cartesi/rollups-examples#advancing-time) so that the Cartesi Node associates a proof with it.

Now with proof associated, the voucher is ready to be executed to return the funds to the depositor by following the instructions available at [Validating notices and executing vouchers](../frontend-console/README.md#validating-notices-and-executing-vouchers).

Finally, after executing the voucher, check the account balance again to confirm that the funds were returned.

```shell
cast balance --rpc-url http://localhost:8545 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
```

## Running the environment in host mode

This DApp's back-end is written in Python, so to run it in your machine you need to have `python3` installed.

In order to start the back-end, run the following commands in a dedicated terminal:

```shell
cd ether/
python3 -m venv .venv
. .venv/bin/activate
pip install -r requirements.txt
ROLLUP_HTTP_SERVER_URL="http://127.0.0.1:5004" NETWORK="localhost" python3 ether.py
```

The final command will effectively run the back-end and send corresponding outputs to port `5004`.
It can optionally be configured in an IDE to allow interactive debugging using features like breakpoints.

You can also use a tool like [entr](https://eradman.com/entrproject/) to restart the back-end automatically when the code changes. For example:

```shell
ls *.py | ROLLUP_HTTP_SERVER_URL="http://127.0.0.1:5004" entr -r python3 ether.py
```

After the back-end successfully starts, it should print an output like the following:

```shell
INFO:__main__:HTTP rollup_server url is http://127.0.0.1:5004
INFO:__main__:Sending finish
```

After that, you can interact with the application normally [as explained above](#interacting-with-the-application).
