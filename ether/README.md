# ETHER DApp

This DApp shows how to parse ETHER deposits sent by the ERTHER Portal, which is where all legitimate ETHER deposits come from, and how to issue vouchers so the amount deposited can be withdrawn later on.

A deposit must have a payload, whose format is defined at the [ETHER Portal contract](https://github.com/cartesi/rollups/blob/main/onchain/rollups/contracts/portals/EtherPortal.sol), which is part of the Cartesi Rollups contract.

After the deposit is parsed, the application issues a voucher to return the amount back to the depositor ("I don't want your money!"). This voucher can then be executed to withdraw the amount from the Portal and recover the assets. Note that to perform a withdrawal, we use the [withdrawEther](https://github.com/cartesi/rollups/blob/29711da9cd83bb56477ea1855286f2c722a17337/onchain/rollups/contracts/dapp/CartesiDApp.sol#L230) method of the DApp contract, differently from the erc20 example where the DApp uses the transfer method of the ERC20 token. To successfully execute this method through a voucher, the DApp needs to know its own Layer-1 address to set the destination field in the voucher.The [Dapp Address Relay](https://github.com/cartesi/rollups/blob/main/onchain/rollups/contracts/relays/DAppAddressRelay.sol) contract is the tool that the Cartesi Rollups framework has available to feed this information to the DApp in a secure way.

Malformed inputs or inputs sent by addresses other than the `DApp Address Relay` and the `Ether Portal` will be rejected.

## Interacting with the application

Before beginning the interaction, declare the variables that we will be using. So first, go to a separate terminal window and execute the commands below to initialize the variables.

> [!IMPORTANT]
> The values used through this interaction consider that the example is running locally.

```shell
export PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
export PUBLIC_KEY="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
export DAPP_ADDRESS="0x142105FC8dA71191b3a13C738Ba0cF4BC33325e2"
export DAPP_ADDRESS_RELAY="0x8Bbc0e6daB541DF0A9f0bDdA5D41B3B08B081d55"
export ETHER_PORTAL_ADDRESS="0xA89A3216F46F66486C9B794C1e28d3c44D59591e"
export RPC_URL="http://localhost:8545"
```

Since this DApp needs to use the `withdrawEther` method of the DApp contract to perform ETHER withdraws, it has to know its own address to encode this method call in a voucher. To provide this information in a trusted way to the DApp use the [relayDAppAddress](https://github.com/cartesi/rollups/blob/29711da9cd83bb56477ea1855286f2c722a17337/onchain/rollups/contracts/relays/DAppAddressRelay.sol#L20) method of the DApp Address Relay Contract to inform your DApp (running on L2) of its L1 address. To execute this method run the command below:

> [!NOTE]
> The image `ghcr.io/foundry-rs/foundry` its from [Foundry](https://book.getfoundry.sh/getting-started/installation) and allow us to use the [cast](https://book.getfoundry.sh/reference/cast/cast) command to send transactions and check the balance.

```shell
docker run --net="host" ghcr.io/foundry-rs/foundry "cast send --private-key $PRIVATE_KEY --rpc-url $RPC_URL $DAPP_ADDRESS_RELAY \"relayDAppAddress(address)\" $DAPP_ADDRESS"
```

Then, perform a deposit of some ETHER.
> [!NOTE]
> Note that the last parameter of the command is the amount of ether you are depositing. Feel free to change the amount if desired.

```shell
docker run --net="host" ghcr.io/foundry-rs/foundry "cast send --private-key $PRIVATE_KEY --rpc-url $RPC_URL $ETHER_PORTAL_ADDRESS \"depositEther(address,bytes)\" $DAPP_ADDRESS 0x --value \"1000ether\""
```

In order to verify the notices generated by your inputs, use the [frontend-console](https://github.com/cartesi/rollups-examples/tree/main/frontend-console):

```shell
yarn start notice list
```

The payload of the notice should be something like this:

```json
"Deposit received from: 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266; ETH Amount: 1000000000000000000000"
```

After the deposit, check the balance of the account used in the operation:

```shell
docker run --net="host" ghcr.io/foundry-rs/foundry "cast balance --rpc-url $RPC_URL $PUBLIC_KEY"
```

In order to check the voucher generated for the deposit, execute the following command:

```shell
yarn start voucher list
```

After confirming the generation of the voucher, advance the time using this [command](https://github.com/cartesi/rollups-examples#advancing-time) so that the Cartesi Node associates a proof with it.

Now with proof associated, the voucher is ready to be executed to return the funds to the depositor by following the instructions available at [Validating notices and executing vouchers](../frontend-console/README.md#validating-notices-and-executing-vouchers).

Finally, after executing the voucher, check the account balance again to confirm that the funds were returned.

```shell
docker run --net="host" ghcr.io/foundry-rs/foundry "cast balance --rpc-url $RPC_URL $PUBLIC_KEY"
```

## Running the environment in host mode

This DApp's back-end is written in Python, so to run it in your machine you need to have `python3` installed.

In order to start the back-end, run the following commands in a dedicated terminal:

```shell
cd ether/
python3 -m venv .venv
. .venv/bin/activate
pip install -r requirements.txt
ROLLUP_HTTP_SERVER_URL="http://127.0.0.1:5004" NETWORK="localhost" python3 ether.py
```

The final command will effectively run the back-end and send corresponding outputs to port `5004`.
It can optionally be configured in an IDE to allow interactive debugging using features like breakpoints.

You can also use a tool like [entr](https://eradman.com/entrproject/) to restart the back-end automatically when the code changes. For example:

```shell
ls *.py | ROLLUP_HTTP_SERVER_URL="http://127.0.0.1:5004" entr -r python3 ether.py
```

After the back-end successfully starts, it should print an output like the following:

```shell
INFO:__main__:HTTP rollup_server url is http://127.0.0.1:5004
INFO:__main__:Sending finish
```

After that, you can interact with the application normally [as explained above](#interacting-with-the-application).
