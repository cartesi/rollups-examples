# Echo Extended DApp

This example shows how to build and interact with a Cartesi Rollups application that does a text transformation for a given message received as a corresponding output notice. The message and the transformation method are sent to the application as a JSON string in Hexadecimal. This DApp's back-end is written in Python. Before understanding the usage of the DApp, we have to build it properly has shown in the Building section.

## Building the environment

To run the Echo Extended DApp example, clone the repository as follows:

```shell
$ git clone https://github.com/cartesi/rollups-examples.git
```

Then, build the back-end for the echo extended example:

```shell
$ cd rollups-examples/echo-extended
$ make machine
```

## Running the environment

To start the containers in production mode, run:

```shell
$ docker-compose up --build
```

_Note:_ If you decide to use [Docker Compose V2](https://docs.docker.com/compose/cli-command/), make sure you set the [compatibility flag](https://docs.docker.com/compose/cli-command-compatibility/) when executing the command (e.g., `docker-compose --compatibility up`).
_Note:_ If running the make files or docker causes an permission failed error, run as super user.

Allow some time for the infrastructure to be ready.
How much will depend on your system, but after some time showing the error `"concurrent call in session"`, eventually the container logs will repeatedly show the following:

```shell
server_manager_1      | Received GetVersion
server_manager_1      | Received GetStatus
server_manager_1      |   default_rollups_id
server_manager_1      | Received GetSessionStatus for session default_rollups_id
server_manager_1      |   0
server_manager_1      | Received GetEpochStatus for session default_rollups_id epoch 0
```

To stop the containers, first end the process with `Ctrl + C`.
Then, remove the containers and associated volumes by executing:

```shell
$ docker-compose down -v
```
## Undestanding the application

![cartesi drawio](https://user-images.githubusercontent.com/4421825/152856411-85dfdecc-97f6-4269-b9f2-004fc3aae7bb.png)


The echo extended application is a simply text transform application who transforms texts inside the cartesi machine. For that, the input is expected as a JSON string with the one message and one transform method. For instance:
```
{"transform": "upper", "message": "hello from echo-extended"}
```
Where the `transform` can be `upper` or `lower` and message is the message thats will be transformed. Note that this JSON string should necessarly be in hexadecimal. For example above, the hexadecimal should be like bellow. 
```
0x7b227472616e73666f726d223a20227570706572222c20226d657373616765223a202268656c6c6f2066726f6d206563686f2d657874656e646564227d
```

In the next section, you can see how to interact the DApp to send inputs and to see the notices array.

## Interacting with the application

### Command-Line Input

With the infrastructure in place, go to a separate terminal window and send an input as follows:

```shell
$ docker exec echo-extended_hardhat_1 npx hardhat --network localhost echo-extended:addInput --input "0x7b227472616e73666f726d223a20227570706572222c20226d657373616765223a202268656c6c6f2066726f6d206563686f2d657874656e646564227d"
```

The input will have been accepted when you receive a response similar to the following one:

```shell
Added input '0x7b227472616e73666f726d223a20227570706572222c20226d657373616765223a202268656c6c6f2066726f6d206563686f2d657874656e646564227d' to epoch '0' (timestamp: 1643998586, signer: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266, tx: 0x765a93faa7acc2a15cb2e577c16ffd0c7d106599c62b0b5c9be9dfc7fc9ee03f)
```
### Seeing Results, notices, and more

In order to verify the notices generated by your inputs, run the command:

```shell
$ curl http://localhost:4000/graphql -H 'Content-Type: application/json' -d '{ "query" : "query getNotice { GetNotice( query: { session_id: \"default_rollups_id\", epoch_index: \"0\", input_index: \"0\" } ) { session_id epoch_index input_index notice_index payload } }" }'
```

The response should be something like this:

```shell
{"data":{"GetNotice":[{"session_id":"default_rollups_id","epoch_index":"0","input_index":"0","notice_index":"0","payload":"7b227472616e73666f726d223a20227570706572222c20226d657373616765223a202268656c6c6f2066726f6d206563686f2d657874656e646564227d"}]}}
```
You can also run those commands in the playground graphql host at "http://localhost:4000/graphql", it is easier to understand and manipulate the structures defined in (https://github.com/cartesi/rollups/blob/main/src/reader/src/graphql/typeDefs/typeDefs.graphql). For example, the GetNotice query can be run in the localhost as shown bellow

![image](https://user-images.githubusercontent.com/4421825/152856704-c0c33c13-f695-4d43-bec3-9b6e6cfb9d07.png)


where you can see the payload result of the message transformation in the "payload" attribute. In this example, every input generates only one notice, so you can get the result of the transformation checking the notices of an input by the index.

We can also see the full array of notices with the GetEpochStatus query with the command bellow

```shell
query{ GetEpochStatus(query:{session_id: "default_rollups_id", epoch_index:"0"})
      { processed_inputs{ input_index 
      result{
        notices{
        payload} } } } }
```

The results will be shown like the image bellow.

![image](https://user-images.githubusercontent.com/4421825/152856017-ac301f70-0dd6-42f2-af55-1312ce17ddd8.png)

## Advancing time

To advance time, in order to simulate the passing of epochs, run:

```shell
$ docker exec echo_hardhat_1 npx hardhat --network localhost util:advanceTime --seconds 864010
```

## Running the environment in host mode

When developing an application, it is often important to easily test and debug it. For that matter, it is possible to run the Cartesi Rollups environment in [host mode](../README.md#host-mode), so that the DApp's back-end can be executed directly on the host machine, allowing it to be debugged using regular development tools such as an IDE.

The first step is to run the environment in host mode using the following command:

```shell
docker-compose -f docker-compose-host.yml up --build
```

The next step is to run the echo server in your machine. The application is written in Python, so you need to have `python3` installed.

In order to start the echo server, run the following commands in a dedicated terminal:

```shell
cd echo/server/
python3 -m venv .env
. .env/bin/activate
pip install -r requirements.txt
HTTP_DISPATCHER_URL="http://127.0.0.1:5004" gunicorn --preload --workers 1 --bind 0.0.0.0:5003 echo-extended:app
```

The echo server will run on port `5003` and send the corresponding notices to port `5004`. After it's successfully started, it should print an output like the following:

```
[2022-01-21 12:38:23,971] INFO in echo: HTTP dispatcher url is http://127.0.0.1:5004
[2022-01-21 12:38:23 -0500] [79032] [INFO] Starting gunicorn 19.9.0
[2022-01-21 12:38:23 -0500] [79032] [INFO] Listening at: http://0.0.0.0:5003 (79032)
[2022-01-21 12:38:23 -0500] [79032] [INFO] Using worker: sync
[2022-01-21 12:38:23 -0500] [79035] [INFO] Booting worker with pid: 79035
```

After that, you can interact with the application normally [as explained above](#interacting-with-the-application).

When you add an input, you should see it being processed by the echo server as follows:

```shell
[2022-01-21 15:58:39,555] INFO in echo: Received advance request body {'metadata': {'msg_sender': '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266', 'epoch_index': 0, 'input_index': 0, 'block_number': 11, 'time_stamp': 1642791522}, 'payload': '0x636172746573690d0a'}
[2022-01-21 15:58:39,556] INFO in echo: Adding notice
[2022-01-21 15:58:39,650] INFO in echo: Received notice status 201 body b'{"index":0}'
[2022-01-21 15:58:39,651] INFO in echo: Finishing
[2022-01-21 15:58:39,666] INFO in echo: Received finish status 202
```

Finally, to stop the containers, removing any associated volumes, execute:

```shell
docker-compose -f docker-compose-host.yml down -v
```
